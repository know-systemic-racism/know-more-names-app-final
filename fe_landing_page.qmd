---
title: "Fatal Encounters in California"
execute:
  echo: false
# css: "/assets/dist/css/bootstrap.min.css"
---

```{python}
import sys
from SPARQLWrapper import SPARQLWrapper, JSON 
import pandas as pd
import plotly.express as px
from urllib.request import urlopen
import json
from IPython.display import HTML
```
```{python}
# Pull people Wikidata entries 

endpoint_url = "https://query.wikidata.org/sparql"
query = """SELECT ?person ?personLabel ?placeOfDeathLabel ?sexOrGenderLabel ?ethnicGroupLabel ?dateOfDeathLabel
          WHERE {
            ?person wdt:P5008 wd:Q120754096.
            ?person wdt:P20 ?placeOfDeath.
            ?person wdt:P21 ?sexOrGender.
            ?person wdt:P172 ?ethnicGroup.
            ?person wdt:P570 ?dateOfDeath.

            SERVICE wikibase:label { bd:serviceParam wikibase:language "en". }
          }"""

def get_results(endpoint_url, query):
    user_agent = "WDQS-example Python/%s.%s" % (sys.version_info[0], sys.version_info[1])
    # TODO adjust user agent; see https://w.wiki/CX6
    sparql = SPARQLWrapper(endpoint_url, agent=user_agent)
    sparql.setQuery(query)
    sparql.setReturnFormat(JSON)
    return sparql.query().convert()
```
```{python}
# Process API results
person_results = get_results(endpoint_url, query)["results"]["bindings"]
fe_arr = []
for result in person_results:
  fe_arr.append({'full_name': result["personLabel"]["value"]})
ojs_define(fe_data = fe_arr)
```
```{python}
# Pull coordinates and titles of death events
endpoint_url = "https://query.wikidata.org/sparql"
query = """SELECT ?person ?personLabel ?coordinates
              WHERE {
                ?person p:P5008 ?statement0.
                ?statement0 (ps:P5008/(wdt:P279*)) wd:Q120754096.
                ?person p:P585 ?statement_1.
                ?statement_1 psv:P585 ?statementValue_1.
                ?statementValue_1 wikibase:timeValue ?P585_1.
                ?person wdt:P625 ?coordinates.
                
                SERVICE wikibase:label { bd:serviceParam wikibase:language "en". }
        }"""

def get_results(endpoint_url, query):
    user_agent = "WDQS-example Python/%s.%s" % (sys.version_info[0], sys.version_info[1])
    # TODO adjust user agent; see https://w.wiki/CX6
    sparql = SPARQLWrapper(endpoint_url, agent=user_agent)
    sparql.setQuery(query)
    sparql.setReturnFormat(JSON)
    return sparql.query().convert()

event_results = get_results(endpoint_url, query)["results"]["bindings"]
```
```{python}
# !pip install pandas geopandas

# import geopandas as gpd
# from shapely.geometry import Point
# Create a DataFrame 
df = pd.DataFrame(event_results)
lat = []
long = []
coords = df['coordinates'].tolist()
# labels = df["personLabel"].tolist()
# names = []
for i in range(len(coords)):
  space = coords[i]["value"].index(' ')
  long.append(float(coords[i]["value"][6:space]))
  lat.append(float(coords[i]["value"][space + 1:-1]))
  # names.append(labels[i]["value"][9:])
df['Latitude'] = lat
df['Longitude'] = long
# df["personLabel"] = names
# isolate victim name from Wikidata label
def isolate_person_name(entry): 
  return entry["value"][9:]
df["personLabel"] = df["personLabel"].map(isolate_person_name)
# print(df['Latitude'], df['Longitude'], df["personLabel"])
  
fig_scatter = px.scatter_mapbox(df, 
                  lat='Latitude',
                  lon='Longitude',
#                   color="Policy_Manual_Exists", 
                  hover_name= df["personLabel"],
                  # hover_data={ 
                  #                 'Age': True, 
                  #                 'Gender': True, 
                  #                 'Race with imputations': True, 
                  #                 ' Date of injury resulting in death (month/day/year)': True, 
                  #                 'Agency or agencies involved': True,
                  #                 'Latitude':False,
                  #                 'Longitude': False
                  #             },
                  color_continuous_scale=px.colors.cyclical.IceFire, 
                  size_max=15, 
                  zoom=10,
                  mapbox_style="carto-positron")

scatter_trace = fig_scatter.data[0]
scatter_trace.marker.color = "#FF6D2C"  # change dot color
scatter_trace.marker.size = 6  # change dot size
# scatter_trace.marker.border.color = "black"
# scatter_trace.update_traces(marker=dict(size=12,
#                               line=dict(width=1,
#                                         color='DarkSlateGrey')),
#                   selector=dict(mode='markers')) 


with urlopen('https://raw.githubusercontent.com/plotly/datasets/master/geojson-counties-fips.json') as response:
    counties = json.load(response)
    # ** the file below is hosted locally but I could alternatively write code that removes all the non-CA fip codes from the DF 
df_counties_ca = pd.read_csv("one_col_raw.githubusercontent.com_plotly_datasets_master_fips-unemp-16.csv",  
                   dtype={"fips": str})
fig_ca_counties = px.choropleth_mapbox(df_counties_ca, 
                           geojson=counties, 
                           locations='fips',
                           color_continuous_scale="Viridis",
                           range_color=(0, 12),
                           mapbox_style="carto-positron",
                           zoom=4.7, 
                           center = {"lat": 37.0902, "lon": -120.7129},
                           opacity=0.5,
                          )
fig_ca_counties.update_geos(fitbounds="locations", visible=False)
fig_ca_counties.update_layout(margin={"r":0,"t":0,"l":0,"b":0})

fig_ca_counties.add_trace(
    scatter_trace
)
# customize hover label appearance
fig_ca_counties.update_layout(
    hoverlabel=dict(
        bgcolor="white",
        font_size=12,
        font_family="Rockwell"
    )
)

# fig_scatter.show()
fig_ca_counties.show()
```
```{ojs}
viewof fe_search = Inputs.search(fe_data, 
{placeholder: "Enter a name", 
width: 1500,
})

```
```{=html}
<div class="entries-wrap">
```
```{ojs}
viewof fe_rows = Inputs.table(fe_search, {
  columns: [
    'full_name',
  ],
  format: {
    'full_name': x => htl.html`<button type="button" style="border-radius: 20px;" class="options">${x}</button>`,
  },
  align: {
    full_name: "center",
  },
  width: {
    full_name: 900,
  },
})
```
```{=html}
</div>
```
```{python, echo=FALSE}
for entry in person_results:
    html_content = """
    <div class="info-card" style="border: 1px solid #ddd; border-radius: 20px; padding: 10px; margin: 10px;">
        <h2>{}</h2>
        <p>{} ({} {}) was killed on {} in {}. To learn more, see this <a>article</a></p>
    </div>
    """.format(entry['personLabel']['value'], entry['personLabel']['value'], entry['ethnicGroupLabel']['value'][:-1], entry['sexOrGenderLabel']['value'], entry['dateOfDeathLabel']['value'], entry['placeOfDeathLabel']['value'])
    display(HTML(html_content)) 
```

